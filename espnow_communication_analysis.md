# ESP-NOW通信逻辑分析

## 1. ESP-NOW通信逻辑
### **Brain模块**
- **通信初始化**:
  - 调用 `WiFi.mode(WIFI_STA)` 设置为站点模式。
  - 使用 `esp_now_init()` 初始化 ESP-NOW。
  - 注册回调函数：
    - `esp_now_register_send_cb()` 用于发送数据后的状态反馈。
    - `esp_now_register_recv_cb()` 用于接收数据。

- **数据发送**:
  - 使用 `esp_now_send()` 向 Hand 模块发送数据包。
  - 数据包结构通常包括舵机角度、喂料器状态等。

- **数据接收**:
  - 在接收回调中解析 Hand 模块返回的状态数据。
  - 更新喂料器状态或执行其他逻辑。

### **Hand模块**
- **通信初始化**:
  - 同样调用 `WiFi.mode(WIFI_STA)` 设置为站点模式。
  - 使用 `esp_now_init()` 初始化 ESP-NOW。
  - 注册回调函数：
    - `esp_now_register_send_cb()` 用于发送数据后的状态反馈。
    - `esp_now_register_recv_cb()` 用于接收数据。

- **数据接收**:
  - 在接收回调中解析 Brain 模块发送的控制指令。
  - 根据指令更新舵机角度或执行其他动作。

- **数据发送**:
  - 使用 `esp_now_send()` 向 Brain 模块发送状态反馈。
  - 数据包结构通常包括舵机当前角度、操作完成状态等。

---

## 2. 开机初始化逻辑
### **Brain模块**
1. **硬件初始化**:
   - 初始化串口通信（`Serial.begin()`）。
   - 初始化喂料器管理器。
   - 加载喂料器配置。

2. **ESP-NOW初始化**:
   - 设置 WiFi 模式为 `WIFI_STA`。
   - 调用 `esp_now_init()` 初始化。
   - 注册发送和接收回调。

3. **G-code处理器初始化**:
   - 初始化 G-code 命令解析器。
   - 设置串口监听。

### **Hand模块**
1. **硬件初始化**:
   - 初始化舵机控制器。
   - 加载舵机配置。

2. **ESP-NOW初始化**:
   - 设置 WiFi 模式为 `WIFI_STA`。
   - 调用 `esp_now_init()` 初始化。
   - 注册发送和接收回调。

---

## 3. 主循环运行逻辑
### **Brain模块**
1. **喂料器状态更新**:
   - 定期检查喂料器状态。
   - 根据状态执行推进或回缩操作。

2. **G-code命令处理**:
   - 监听串口数据。
   - 解析并执行 G-code 命令。

3. **ESP-NOW通信**:
   - 发送控制指令到 Hand 模块。
   - 接收 Hand 模块的状态反馈。

### **Hand模块**
1. **舵机状态更新**:
   - 定期检查舵机状态。
   - 根据目标角度更新舵机位置。

2. **ESP-NOW通信**:
   - 接收 Brain 模块的控制指令。
   - 执行指令并发送状态反馈。

---

## 总结
Brain 和 Hand 模块通过 ESP-NOW 实现无线通信，Brain 负责发送控制指令，Hand 负责执行指令并反馈状态。两者的初始化逻辑类似，均包括硬件初始化和 ESP-NOW 初始化。主循环中，Brain 侧重于喂料器管理和 G-code 命令处理，Hand 侧重于舵机控制和状态反馈。