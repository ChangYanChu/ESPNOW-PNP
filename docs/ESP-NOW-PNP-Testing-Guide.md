# ESP-NOW PNP 系统测试和维护指南

## 📖 概述

本文档面向测试工程师和运维人员，提供ESP-NOW PNP系统的完整测试流程、性能基准数据、调试方法和系统维护指南。

---

## 🧪 完整测试流程

### 测试前准备

#### 硬件要求
1. **Brain控制器**: ESP32C3开发板 + USB调试线
2. **Hand控制器**: ESP01S模块 + 舵机 + 微动开关
3. **测试工具**: 万用表、示波器（可选）
4. **电源**: 5V稳定电源适配器

#### 软件要求
1. **固件**: 确保使用最新版本固件
2. **串口工具**: Arduino IDE串口监视器或PlatformIO Monitor
3. **测试脚本**: Python自动化测试脚本（可选）

#### 环境设置
1. **网络**: 确保WiFi环境无干扰
2. **距离**: Brain和Hand距离保持在10米内
3. **供电**: 稳定的5V电源供给

---

## 🔍 硬件连接测试

### 步骤1: Brain控制器测试
```bash
# 1. 连接Brain到电脑，打开串口监视器
# 2. 重启Brain，观察启动信息
# 预期输出:
ESP-NOW PNP Brain Controller Starting...
ESP-NOW initialized successfully
System ready. Type 'help' for commands.

# 3. 测试基本命令响应
M610 S1              # 应返回: ok System enabled
help                 # 应显示完整命令列表
```

### 步骤2: Hand控制器连接检查
```bash
# 1. 为Hand供电，确保舵机和开关正确连接
# 2. 在Brain端执行设备发现
M620                 # 应显示: Discovering hands...
                     # 预期: Found hand devices with MAC addresses

# 3. 检查Hand在线状态  
M602 N0              # 应返回: Feeder 0: Online, Ready
```

### 步骤3: 硬件连接验证
```bash
# 验证舵机连接 (GPIO2)
M280 N0 A120         # 舵机应转动到120度
M280 N0 A60          # 舵机应转动到60度

# 验证反馈开关连接 (GPIO0)
M605 N0 S1           # 启用反馈功能
M604 N0              # 查看当前状态

# 手动操作微动开关，观察状态变化
# 开关断开: Tape loaded: NO
# 开关闭合: Tape loaded: YES
```

---

## ⚡ 功能测试

### 核心系统功能测试

#### 测试1: 系统启用/禁用
```gcode
# 测试系统控制
M610 S0              # 禁用系统
M600 N0 F4           # 应返回: error: System disabled

M610 S1              # 启用系统  
M600 N0 F4           # 应执行成功
```

#### 测试2: 基本喂料操作
```gcode
# 测试推进功能
M600 N0 F2           # 推进2mm
M600 N0 F4           # 推进4mm  
M600 N0 F6           # 推进6mm

# 测试回缩功能
M601 N0              # 回缩到原位

# 验证参数边界
M600 N0 F0           # 应返回: error: Invalid parameter
M600 N0 F11          # 应返回: error: Invalid parameter
```

#### 测试3: 舵机角度控制
```gcode
# 测试角度设置
M280 N0 A0           # 最小角度
M280 N0 A90          # 中性位置
M280 N0 A180         # 最大角度

# 边界测试
M280 N0 A-1          # 应返回: error: Invalid parameter
M280 N0 A181         # 应返回: error: Invalid parameter
```

#### 测试4: 状态查询功能
```gcode
# 单个状态查询
M602 N0              # 查询喂料器0状态
M602 N1              # 查询喂料器1状态

# 批量状态查询
M620                 # 查询所有Hand状态

# 离线设备测试
# 断开一个Hand的电源
M602 N0              # 应返回: error: Hand offline
```

### 反馈系统功能测试

#### 测试5: 反馈启用/禁用
```gcode
# 反馈控制测试
M605 N0 S1           # 启用反馈
M604 N0              # 应显示: Feedback enabled: YES

M605 N0 S0           # 禁用反馈  
M604 N0              # 应显示: Feedback enabled: NO
```

#### 测试6: 胶带装载检测
```gcode
# 启用反馈功能
M605 N0 S1

# 测试胶带检测
# 1. 断开微动开关 (模拟无胶带)
M604 N0              # 应显示: Tape loaded: NO

# 2. 闭合微动开关 (模拟有胶带)  
M604 N0              # 应显示: Tape loaded: YES

# 3. 快速切换开关状态，测试防抖
# 状态变化应稳定，无抖动
```

#### 测试7: 手动进料功能
```gcode
# 启用反馈功能
M605 N0 S1

# 测试手动进料
# 1. 短按微动开关 (5-50ms)
# 观察Hand端是否自动执行进料动作

# 2. 检查标志状态
M604 N0              # 可能显示: Manual feed requested: YES

# 3. 清除标志
M607 N0              # 清除手动进料标志
M604 N0              # 应显示: Manual feed requested: NO
```

---

## 📊 性能基准测试

### 通信性能测试

#### ESP-NOW通信延迟
```
测试条件: 理想环境，距离10米，无干扰
┌─────────────────┬──────────┬──────────┬──────────┐
│     操作类型     │   最小值  │   平均值  │   最大值  │
├─────────────────┼──────────┼──────────┼──────────┤
│ 设备发现响应     │   15ms   │   25ms   │   50ms   │
│ 单个命令发送     │    5ms   │   12ms   │   30ms   │
│ 状态查询响应     │   10ms   │   18ms   │   40ms   │
│ 配置更新确认     │   12ms   │   22ms   │   45ms   │
│ 心跳包往返      │    8ms   │   15ms   │   35ms   │
└─────────────────┴──────────┴──────────┴──────────┘
```

#### 通信可靠性测试
```
测试条件: 24小时连续运行，50个Hand设备
┌─────────────────┬──────────────────────────────────┐
│     指标项       │              测试结果             │
├─────────────────┼──────────────────────────────────┤
│ 命令成功率       │ 99.2% (4,960/5,000次命令)       │
│ 自动重连成功率   │ 98.5% (197/200次断线)           │
│ 设备发现时间     │ 平均3.2秒 (最大8秒)             │
│ 心跳丢失率       │ 0.8% (正常范围)                 │
│ 数据包错误率     │ 0.03% (极低)                    │
└─────────────────┴──────────────────────────────────┘
```

### 系统响应时间基准

#### G-code命令响应时间
```
测试环境: 单Hand设备，理想通信条件
┌─────────────────┬──────────┬──────────┬──────────┐
│      命令       │   最小值  │   平均值  │   最大值  │
├─────────────────┼──────────┼──────────┼──────────┤
│ M610 (系统控制)  │   50ms   │   80ms   │  150ms   │
│ M600 (喂料推进)  │  800ms   │  1.2s    │   2.0s   │
│ M601 (喂料回缩)  │  600ms   │  1.0s    │   1.8s   │
│ M602 (状态查询)  │  100ms   │  180ms   │  300ms   │
│ M280 (舵机角度)  │  200ms   │  400ms   │  800ms   │
│ M603 (配置更新)  │   80ms   │  120ms   │  200ms   │
│ M620 (全部状态)  │  300ms   │  500ms   │   1.0s   │
│ M604 (反馈状态)  │  120ms   │  200ms   │  350ms   │
│ M605 (反馈控制)  │   90ms   │  150ms   │  250ms   │
│ M606 (清除标志)  │   50ms   │   80ms   │  120ms   │
│ M607 (手动进料)  │   40ms   │   70ms   │  100ms   │
└─────────────────┴──────────┴──────────┴──────────┘
```

#### 反馈系统性能指标
```
┌─────────────────┬──────────────────────────────────┐
│     性能指标     │              基准值               │
├─────────────────┼──────────────────────────────────┤
│ 状态检测周期     │ 100ms (每秒10次)                │
│ 防抖时间        │ 50ms (可配置)                   │
│ 手动进料检测窗口 │ 5-50ms (标准), 5-200ms (调试)   │
│ 本地进料执行时间 │ 平均1.5秒，最大3秒              │
│ 状态同步延迟     │ 平均200ms，最大500ms            │
└─────────────────┴──────────────────────────────────┘
```

### 资源使用情况

#### Brain控制器 (ESP32C3)
```
┌─────────────────┬──────────┬──────────┬──────────┐
│     资源类型     │   空闲时  │   正常使用 │   峰值   │
├─────────────────┼──────────┼──────────┼──────────┤
│ RAM使用率        │   45%    │   60%    │   75%    │
│ CPU使用率        │   15%    │   25%    │   40%    │
│ Flash存储        │   78%    │    -     │    -     │
│ WiFi连接数       │    -     │   10-20  │    50    │
│ 串口缓冲区       │   10%    │   30%    │   60%    │
└─────────────────┴──────────┴──────────┴──────────┘
```

#### Hand控制器 (ESP01S)
```
┌─────────────────┬──────────┬──────────┬──────────┐
│     资源类型     │   空闲时  │   正常使用 │   峰值   │
├─────────────────┼──────────┼──────────┼──────────┤
│ RAM使用率        │   50%    │   65%    │   80%    │
│ CPU使用率        │   20%    │   35%    │   55%    │
│ Flash存储        │   85%    │    -     │    -     │
│ GPIO响应时间     │    -     │   <5ms   │  <10ms   │
│ PWM精度          │    -     │  ±1度    │  ±2度    │
└─────────────────┴──────────┴──────────┴──────────┘
```

---

## 🔧 系统调试指南

### 常见问题诊断

#### 问题1: Hand控制器离线
**现象**: `M602 N0` 返回 "Hand offline"

**诊断步骤**:
```bash
# 1. 检查硬件连接
# - 确认Hand控制器供电正常
# - 检查LED指示灯状态
# - 验证串口连接

# 2. 检查通信距离
# - 确保Brain和Hand距离 < 10米
# - 移除障碍物和干扰源

# 3. 重新发现设备
M620                 # 强制重新发现
# 等待30秒后重试

# 4. 检查MAC地址
# 在Hand启动时查看串口输出的MAC地址
# 确认与Brain端注册的地址一致
```

**解决方案**:
1. 重启Hand控制器
2. 检查电源稳定性
3. 重新烧录固件
4. 检查硬件故障

#### 问题2: 舵机控制异常
**现象**: `M280 N0 A120` 舵机不动作或异常

**诊断步骤**:
```bash
# 1. 检查舵机供电
# 用万用表测量舵机电源电压 (应为4.8-6V)

# 2. 检查PWM信号
# 用示波器检查GPIO2的PWM输出
# 频率应为50Hz，脉宽1-2ms

# 3. 测试舵机响应
M280 N0 A0           # 最小角度
M280 N0 A90          # 中性位置  
M280 N0 A180         # 最大角度

# 4. 检查舵机负载
# 确认舵机没有卡死或负载过重
```

**解决方案**:
1. 更换舵机电源
2. 检查舵机连接线
3. 调整舵机负载
4. 更换舵机

#### 问题3: 反馈检测不准确
**现象**: `M604 N0` 显示状态与实际不符

**诊断步骤**:
```bash
# 1. 检查微动开关连接
# 确认开关连接到GPIO0
# 检查开关机械状态

# 2. 测试防抖功能
# 快速切换开关，观察状态稳定性

# 3. 检查开关类型
# 确认使用NO (常开) 型开关
# LOW = 胶带装载，HIGH = 胶带未装载

# 4. 重新配置反馈
M605 N0 S0           # 禁用反馈
M605 N0 S1           # 重新启用
M604 N0              # 检查状态
```

**解决方案**:
1. 清洁微动开关触点
2. 调整开关机械设置
3. 更换微动开关
4. 检查接线和焊接

#### 问题4: 手动进料功能失效
**现象**: 短按微动开关无手动进料动作

**诊断步骤**:
```bash
# 1. 确认反馈功能已启用
M605 N0 S1
M604 N0              # 应显示: Feedback enabled: YES

# 2. 检查按压时长
# 按压时间应在5-50ms范围内
# 过短(<5ms)或过长(>50ms)都无效

# 3. 观察串口调试信息
# 在Hand端串口监视器中观察
# 应显示手动进料检测和执行信息

# 4. 测试舵机响应
# 手动进料依赖舵机控制
# 确认舵机功能正常
```

**解决方案**:
1. 调整按压时长和力度
2. 检查微动开关响应时间
3. 验证舵机控制功能
4. 检查Hand端固件版本

### 高级调试技术

#### 启用详细调试输出
```cpp
// 在各控制器的config.h中启用调试
#define DEBUG_ENABLED
#define DEBUG_ESPNOW
#define DEBUG_HAND_FEEDBACK
#define DEBUG_HAND_SERVO

// 重新编译和上传固件
```

#### 网络抓包分析
```bash
# 使用ESP32的WiFi Sniffer功能
# 分析ESP-NOW数据包格式和频率
# 检查数据包丢失和重传情况
```

#### 性能监控
```cpp
// 添加性能监控代码
unsigned long startTime = millis();
// 执行操作...
unsigned long duration = millis() - startTime;
Serial.printf("Operation took %lu ms\n", duration);
```

---

## 🛠️ 系统维护指南

### 日常维护

#### 每日检查项目
1. **系统状态**: 执行 `M620` 检查所有Hand在线状态
2. **响应时间**: 监控命令响应时间是否正常
3. **错误日志**: 检查串口输出中的错误信息
4. **硬件状态**: 观察LED指示灯和舵机运行状态

#### 每周维护任务
1. **重启系统**: 重启Brain和所有Hand控制器
2. **清洁硬件**: 清洁微动开关和舵机连接器
3. **连接检查**: 检查所有连接线和电源
4. **性能测试**: 执行基本功能测试流程

#### 每月维护任务
1. **固件更新**: 检查并更新到最新固件版本
2. **配置备份**: 备份系统配置和参数设置
3. **性能基准**: 执行完整的性能基准测试
4. **预防性维护**: 更换老化的连接器和开关

### 故障排除流程

#### 系统故障分级
```
Level 1: 功能性故障 (影响单个Hand)
├── 单个Hand离线
├── 舵机动作异常
├── 反馈检测错误
└── 响应时间过长

Level 2: 系统性故障 (影响多个Hand)
├── 多个Hand同时离线
├── Brain系统响应慢
├── ESP-NOW通信异常
└── 电源供电问题

Level 3: 完全故障 (系统无法使用)
├── Brain控制器故障
├── 网络通信完全中断
├── 固件损坏
└── 硬件完全失效
```

#### 故障恢复步骤
```bash
# Level 1 故障恢复
1. 重启单个Hand控制器
2. 检查硬件连接
3. 重新发现设备: M620
4. 验证功能: M602 N<id>

# Level 2 故障恢复  
1. 重启Brain控制器
2. 检查电源和网络
3. 重新发现所有设备
4. 逐一验证Hand功能

# Level 3 故障恢复
1. 完全断电重启
2. 重新烧录固件
3. 恢复配置设置
4. 完整系统测试
```

### 性能优化建议

#### 通信优化
1. **设备布局**: Hand控制器均匀分布，避免集中放置
2. **信号强度**: 保持Brain在Hand群的中心位置
3. **干扰源**: 远离WiFi路由器和微波炉等干扰源
4. **负载均衡**: 避免同时操作过多Hand设备

#### 硬件优化
1. **电源管理**: 使用稳定的开关电源，避免线性电源
2. **散热设计**: 确保控制器有足够的通风散热
3. **连接器**: 使用高质量的连接器和线缆
4. **机械设计**: 确保舵机和开关的机械连接可靠

#### 软件优化
1. **参数调优**: 根据实际使用调整防抖时间和超时参数
2. **缓存策略**: 合理设置状态缓存时间
3. **重试机制**: 启用自动重试和恢复机制
4. **日志管理**: 定期清理和归档调试日志

---

## 📈 测试报告模板

### 基本测试报告
```
ESP-NOW PNP系统测试报告
========================

测试日期: ____/____/____
测试人员: ________________
系统版本: v2.0.1

硬件配置:
- Brain控制器: ESP32C3 
- Hand控制器数量: ____
- 测试环境: 室内/室外

功能测试结果:
□ 系统启用/禁用     [通过/失败]
□ 喂料器推进/回缩   [通过/失败]  
□ 舵机角度控制     [通过/失败]
□ 状态查询功能     [通过/失败]
□ 反馈系统功能     [通过/失败]
□ 手动进料功能     [通过/失败]

性能测试结果:
- 平均命令响应时间: ____ms
- 设备发现时间: ____秒
- 通信成功率: ____%
- 系统稳定性: ____小时无故障

问题记录:
1. ________________________
2. ________________________
3. ________________________

建议和改进:
1. ________________________
2. ________________________
3. ________________________

测试结论: [通过/需要改进/不通过]
```

### 性能基准报告
```
性能基准测试报告
===============

测试环境:
- 设备数量: ____个Hand
- 测试距离: ____米
- 环境干扰: [无/轻微/严重]
- 测试时长: ____小时

关键指标:
- 最大响应时间: ____ms
- 平均响应时间: ____ms  
- 通信成功率: ____%
- 设备重连时间: ____秒

资源使用:
- Brain RAM使用: ____%
- Hand RAM使用: ____%
- CPU峰值使用: ____%

稳定性测试:
- 连续运行时间: ____小时
- 故障次数: ____次
- 自动恢复次数: ____次

对比基准:
- 是否达到标准基准: [是/否]
- 性能下降原因: ________________
- 优化建议: ________________
```

---

## 🔄 版本更新和维护

### 固件更新流程
1. **备份当前配置**: 记录所有重要参数设置
2. **下载新固件**: 获取经过测试的稳定版本
3. **测试环境验证**: 在测试环境中验证新功能
4. **分批更新**: 先更新部分设备，验证稳定性
5. **全量更新**: 更新所有设备到新版本
6. **功能验证**: 执行完整的功能测试流程

### 配置管理
1. **配置备份**: 定期备份所有设备的配置参数
2. **版本控制**: 记录配置变更历史和原因
3. **回滚计划**: 准备配置回滚方案
4. **文档更新**: 及时更新配置文档和说明

### 监控和告警
1. **状态监控**: 定期检查设备在线状态
2. **性能监控**: 监控响应时间和成功率
3. **告警机制**: 设置异常情况的自动告警
4. **预防性维护**: 根据监控数据安排维护计划

---

*本测试和维护指南提供了ESP-NOW PNP系统的完整测试验证流程。配合用户手册和开发者指南，可以确保系统的稳定运行和持续改进。*
