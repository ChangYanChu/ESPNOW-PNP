# ESP-NOW PNP 系统用户手册

## 📖 概述

ESP-NOW PNP 系统是一个基于 ESP32C3 (Brain) 和 ESP01S (Hand) 的分布式Pick and Place喂料器控制系统。通过无线ESP-NOW协议实现Brain控制器与多个Hand控制器的通信，支持精确的喂料控制和实时反馈监测。

### 🎯 主要特性
- **无线控制**: 基于ESP-NOW的可靠无线通信
- **分布式架构**: 单个Brain控制器管理多达50个Hand控制器
- **精确控制**: 支持舵机角度控制和喂料长度设定
- **实时反馈**: 微动开关监测胶带装载状态
- **手动操作**: 支持手动进料和本地处理
- **自动发现**: 智能设备发现和注册

---

## 🚀 快速开始

### 硬件准备
1. **Brain控制器**: ESP32C3开发板 + USB连接线
2. **Hand控制器**: ESP01S模块 + 舵机 + 微动开关
3. **电源**: 5V电源适配器（为舵机供电）

### 软件准备
1. 烧录对应固件到Brain和Hand控制器
2. 打开串口监视器（波特率115200）
3. 连接Brain控制器到电脑

### 基本操作流程

#### 1. 系统启动
```gcode
M610 S1          # 启用系统
```
**预期响应**: `ok System enabled`

#### 2. 检查设备状态
```gcode
M620             # 查询所有Hand状态
```
**预期响应**: 显示所有在线Hand的状态信息

#### 3. 基本喂料操作
```gcode
M602 N0          # 检查喂料器0状态
M600 N0 F4       # 喂料器0推进4mm
M601 N0          # 喂料器0回缩
```

#### 4. 启用反馈功能
```gcode
M605 N0 S1       # 启用喂料器0反馈
M604 N0          # 检查反馈状态
```

---

## 📋 G-code命令速查表

### 🔧 核心系统命令

| 命令 | 功能 | 语法 | 示例 | 响应时间 |
|------|------|------|------|----------|
| **M610** | 系统启用/禁用 | `M610 S<0/1>` | `M610 S1` | < 100ms |
| **M600** | 喂料器推进 | `M600 N<id> F<length>` | `M600 N0 F4` | < 2秒 |
| **M601** | 喂料器回缩 | `M601 N<id>` | `M601 N0` | < 2秒 |
| **M602** | 状态查询 | `M602 N<id>` | `M602 N0` | < 500ms |
| **M280** | 舵机角度 | `M280 N<id> A<angle>` | `M280 N0 A120` | < 1秒 |
| **M603** | 配置更新 | `M603 N<id> A<angle> F<length>` | `M603 N0 A120 F4` | < 200ms |
| **M620** | 所有状态 | `M620` | `M620` | < 1秒 |

### 🔧 反馈系统命令

| 命令 | 功能 | 语法 | 示例 | 响应时间 |
|------|------|------|------|----------|
| **M604** | 反馈状态检查 | `M604 N<id>` | `M604 N0` | < 500ms |
| **M605** | 启用/禁用反馈 | `M605 N<id> S<0/1>` | `M605 N0 S1` | < 200ms |
| **M606** | 清除手动进料标志 | `M606 N<id>` | `M606 N0` | < 100ms |
| **M607** | 手动进料处理 | `M607 N<id>` | `M607 N0` | < 100ms |

### 📝 参数说明

- **N**: 喂料器编号 (0-49)
- **S**: 状态值 (0=禁用, 1=启用) 
- **F**: 喂料长度 (毫米，1-10范围)
- **A**: 舵机角度 (度，0-180范围)

---

## 🎮 常用操作流程

### 标准喂料流程
```gcode
# 1. 启用系统
M610 S1

# 2. 检查喂料器状态
M602 N0

# 3. 启用反馈（如果需要）
M605 N0 S1

# 4. 验证胶带装载
M604 N0

# 5. 执行喂料
M600 N0 F4

# 6. 检查完成状态
M602 N0

# 7. 回缩（如果需要）
M601 N0
```

### 批量设备检查
```gcode
# 检查所有设备状态
M620

# 逐个检查特定设备
M602 N0
M602 N1  
M602 N2
```

### 手动进料处理
```gcode
# 检查手动进料请求
M604 N0

# 处理手动进料（清除标志）
M607 N0

# 验证处理结果
M604 N0
```

---

## ⚡ 性能指标摘要

### 系统响应时间
- **命令响应**: 通常 < 500ms
- **喂料操作**: 通常 < 2秒
- **状态查询**: 通常 < 200ms
- **设备发现**: 通常 < 5秒

### 通信可靠性
- **命令成功率**: > 99%（理想环境）
- **最大设备数**: 50个Hand控制器
- **通信距离**: 室内10-30米
- **重连时间**: < 10秒

### 系统稳定性
- **连续运行**: > 24小时无故障
- **内存使用**: Brain < 70%，Hand < 60%
- **CPU使用**: 平均 < 30%

---

## ❗ 响应代码说明

### 成功响应
- `ok` - 命令执行成功
- `ok System enabled` - 系统启用成功
- `ok System disabled` - 系统禁用成功
- `ok Feeder X: status_info` - 状态查询成功

### 错误响应
- `error: System disabled` - 系统未启用
- `error: Invalid feeder number` - 无效喂料器编号
- `error: Hand offline` - Hand控制器离线
- `error: Invalid parameter` - 参数错误
- `error: Timeout` - 操作超时

### 反馈状态响应
- `Tape loaded: YES/NO` - 胶带装载状态
- `Manual feed requested: YES/NO` - 手动进料请求状态
- `Feedback enabled: YES/NO` - 反馈功能状态

---

## 🛠️ 基本故障排除

### 常见问题及解决方案

#### 问题1: Hand控制器离线
**现象**: 执行命令时提示 "Hand offline"
**解决步骤**:
1. 检查Hand控制器电源连接
2. 检查WiFi距离（建议 < 10米）
3. 执行 `M620` 重新发现设备
4. 重启Hand控制器

#### 问题2: 喂料操作无响应
**现象**: M600/M601命令无反应
**解决步骤**:
1. 确认系统已启用：`M610 S1`
2. 检查喂料器编号是否正确
3. 检查舵机电源和连接
4. 查看串口错误信息

#### 问题3: 反馈检测不准确
**现象**: M604显示状态不符合实际
**解决步骤**:
1. 检查微动开关连接到GPIO0
2. 检查开关机械状态
3. 重新启用反馈：`M605 N0 S0` 然后 `M605 N0 S1`
4. 检查胶带张力是否适当

#### 问题4: 命令响应慢
**现象**: 命令执行时间过长
**解决步骤**:
1. 检查WiFi信号强度
2. 减少同时操作的Hand数量
3. 检查串口波特率设置（应为115200）
4. 重启Brain控制器

### 性能优化建议

1. **通信优化**:
   - 保持Brain和Hand距离 < 10米
   - 避免WiFi干扰源
   - 一次只操作1-2个Hand

2. **操作优化**:
   - 批量操作前先检查状态
   - 合理设置喂料长度（推荐2-6mm）
   - 定期检查机械连接

3. **维护建议**:
   - 每周重启一次控制器
   - 定期清洁微动开关
   - 检查舵机运行状态

---

## 📞 获取更多帮助

### 文档资源
- **开发者指南**: 详细的技术实现和扩展开发
- **测试指南**: 完整的测试流程和性能基准

### 系统信息
- **版本**: v2.0.1
- **最后更新**: 2024年
- **兼容性**: ESP32C3 + ESP01S

### 技术支持
如需更详细的技术信息或遇到复杂问题，请参考开发者指南或联系技术支持。

---

*本手册涵盖了ESP-NOW PNP系统的基本使用方法。对于系统架构、扩展开发、性能调优等高级主题，请参考开发者指南和测试指南。*
